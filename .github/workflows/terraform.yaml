name: terraform-workflow

on:
    push:
        branches:
            - main
    workflow_dispatch:

jobs:
    terraform-job:
        runs-on: 'ubuntu-latest'
        env:
            TF_VAR_subscription_id: ${{ secrets.TF_VAR_SUBSCRIPTION_ID }}
            TF_VAR_tenant_id: ${{ secrets.TF_VAR_TENANT_ID }}
            TF_VAR_client_id:  ${{ secrets.TF_VAR_CLIENT_ID }}
            TF_VAR_client_secret: ${{ secrets.TF_VAR_CLIENT_SECRET }}
        steps:
            - name: checkout_code
              uses: actions/checkout@v3

            - name: terraform-install
              uses: hashicorp/setup-terraform@v3
              with:
                terraform_version: 'latest'

            - name: Terraform-Init
              run: terraform init -backend-config="resource_group_name=gh-grp" -backend-config="storage_account_name=ahamedstorageaccount5000" -backend-config="container_name=terrafromcontainer" -backend-config="key=terraform.tfstate"

            - name: Terraform-Validate
              run: terraform validate

            - name: Terraform-Plan
              run: terraform plan -out=tfplan
            
            - name: Terraform-Apply
              run: terraform apply -auto-approve tfplan

            - name: Terrafrom-StateFile-Upload
              uses: actions/upload-artifact@v4
              with:
                name: terraform-statefile
                path: terraform.tfstate



